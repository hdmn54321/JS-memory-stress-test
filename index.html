<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memory Leak Test</title>
  <style>
    :root { font-family: system-ui, sans-serif; }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1.25rem;
      height: 100vh;
      margin: 0;
      background: #fdfdfd;
    }
    h1 { font-size: 1.25rem; font-weight: 500; margin: 0; }
    #status { font-size: 0.9rem; color: #333; }
    button {
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      transition: background 0.15s;
    }
    button:hover { background: #f0f0f0; }
    #controls { display: flex; gap: 0.5rem; align-items: center; }
    #speedDisplay { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <h1>Memory Leak Test — open DevTools → Performance → Memory to observe growth</h1>
  <div id="status">Waiting&hellip;</div>
  <div id="controls">
    <button id="slower">&minus; slower</button>
    <span>Speed: <span id="speedDisplay"></span> MB/s</span>
    <button id="faster">faster &plus;</button>
  </div>

  <script>
    // =====================================
    // Aggressive Memory Leak Demo w/ Controls & Live Stats
    // =====================================
    (function () {
      const MB = 1024 * 1024;
      const CHUNK_MB = 1;            // size per allocation (MiB)
      let intervalMs = 50;           // start at 50 ms → 20 MB/s
      const bucket = [];             // never released → leak
      let timerId;

      function allocateChunk() {
        bucket.push('x'.repeat(CHUNK_MB * MB));
      }

      function startLeak() {
        clearInterval(timerId);
        timerId = setInterval(allocateChunk, intervalMs);
      }

      // --- UI helpers ---
      const statusEl = document.getElementById('status');
      const speedEl  = document.getElementById('speedDisplay');

      function updateSpeedLabel() {
        speedEl.textContent = (1000 / intervalMs * CHUNK_MB).toFixed(0);
      }

      // Update stats every second
      setInterval(() => {
        const leakMB = bucket.length * CHUNK_MB;
        const heap = (performance.memory?.usedJSHeapSize || 0) / MB;
        const heapLabel = performance.memory ? `${heap.toFixed(0)} MB` : 'n/a';
        statusEl.textContent = `Chunks: ${bucket.length} (~${leakMB} MB) | JS Heap: ${heapLabel}`;
      }, 1000);

      // --- Controls ---
      document.getElementById('faster').addEventListener('click', () => {
        intervalMs = Math.max(Math.floor(intervalMs / 2), 1); // halve until 1 ms
        startLeak();
        updateSpeedLabel();
      });

      document.getElementById('slower').addEventListener('click', () => {
        intervalMs = Math.min(intervalMs * 2, 10000); // double up to 10 s
        startLeak();
        updateSpeedLabel();
      });

      // Init
      updateSpeedLabel();
      startLeak();
    })();
  </script>
</body>
</html>
